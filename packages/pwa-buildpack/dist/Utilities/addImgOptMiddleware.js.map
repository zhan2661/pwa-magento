{"version":3,"sources":["../../src/Utilities/addImgOptMiddleware.js"],"names":["debug","require","makeFileLogger","__filename","cache","expressSharp","missingDeps","markDepInvalid","dep","e","message","split","middleware","addImgOptMiddleware","app","env","process","imgOptConfig","baseHost","MAGENTO_BACKEND_URL","mountPoint","IMAGE_SERVICE_PATH","cacheExpires","IMAGE_CACHE_EXPIRES","debugCache","IMAGE_CACHE_DEBUG","redis","IMAGE_CACHE_REDIS_CLIENT","cacheMiddleware","sharpMiddleware","redisClient","console","warn","use","module","exports"],"mappings":";;AAAA,MAAMA,KAAK,GAAGC,OAAO,CAAC,eAAD,CAAP,CAAyBC,cAAzB,CAAwCC,UAAxC,CAAd;;AACA,IAAIC,KAAJ;AACA,IAAIC,YAAJ;AACA,IAAIC,WAAW,GAAG,EAAlB;;AACA,MAAMC,cAAc,GAAG,CAACC,GAAD,EAAMC,CAAN,KAAY;AAC/BH,EAAAA,WAAW,IAAK,KAAIE,GAAI,aAAYC,CAAC,CAACC,OAAF,CAAUC,KAAV,CAAgB,IAAhB,EAAsB,CAAtB,CAAyB,IAA7D;AACH,CAFD;;AAGA,IAAI;AACAP,EAAAA,KAAK,GAAGH,OAAO,CAAC,UAAD,CAAP,CAAoBW,UAA5B;AACH,CAFD,CAEE,OAAOH,CAAP,EAAU;AACRF,EAAAA,cAAc,CAAC,UAAD,EAAaE,CAAb,CAAd;AACH;;AACD,IAAI;AACAJ,EAAAA,YAAY,GAAGJ,OAAO,CAAC,wBAAD,CAAtB;AACH,CAFD,CAEE,OAAOQ,CAAP,EAAU;AACRF,EAAAA,cAAc,CAAC,wBAAD,EAA2BE,CAA3B,CAAd;AACH;;AAED,SAASI,mBAAT,CAA6BC,GAA7B,EAAkCC,GAAG,GAAGC,OAAO,CAACD,GAAhD,EAAqD;AACjD,QAAME,YAAY,GAAG;AACjBC,IAAAA,QAAQ,EAAEH,GAAG,CAACI,mBADG;AAEjBC,IAAAA,UAAU,EAAEL,GAAG,CAACM,kBAFC;AAGjBC,IAAAA,YAAY,EAAEP,GAAG,CAACQ,mBAHD;AAIjBC,IAAAA,UAAU,EAAET,GAAG,CAACU,iBAJC;AAKjBC,IAAAA,KAAK,EAAEX,GAAG,CAACY;AALM,GAArB;AAOA3B,EAAAA,KAAK,CACA,6EADA,EAEDiB,YAFC,CAAL;AAIA,MAAIW,eAAJ;AACA,MAAIC,eAAJ;;AACA,MAAI;AACAD,IAAAA,eAAe,GAAGxB,KAAK,CAACa,YAAY,CAACK,YAAd,EAA4B,IAA5B,EAAkC;AACrDtB,MAAAA,KAAK,EAAEiB,YAAY,CAACO,UADiC;AAErDM,MAAAA,WAAW,EACPb,YAAY,CAACS,KAAb,IACAzB,OAAO,CAAC,OAAD,CAAP,CAAiB6B,WAAjB,CAA6Bb,YAAY,CAACS,KAA1C;AAJiD,KAAlC,CAAvB;AAMH,GAPD,CAOE,OAAOjB,CAAP,EAAU;AACRF,IAAAA,cAAc,CAAC,UAAD,EAAaE,CAAb,CAAd;AACH;;AACD,MAAI;AACAoB,IAAAA,eAAe,GAAGxB,YAAY,CAAC;AAC3Ba,MAAAA,QAAQ,EAAED,YAAY,CAACC;AADI,KAAD,CAA9B;AAGH,GAJD,CAIE,OAAOT,CAAP,EAAU;AACRF,IAAAA,cAAc,CAAC,wBAAD,EAA2BE,CAA3B,CAAd;AACH;;AACD,MAAIH,WAAJ,EAAiB;AACbyB,IAAAA,OAAO,CAACC,IAAR,CACK;EACX1B,WAAY;;;;gDAFN;AAQH,GATD,MASO;AACHQ,IAAAA,GAAG,CAACmB,GAAJ,CAAQhB,YAAY,CAACG,UAArB,EAAiCQ,eAAjC,EAAkDC,eAAlD;AACH;AACJ;;AAEDK,MAAM,CAACC,OAAP,GAAiBtB,mBAAjB","sourcesContent":["const debug = require('../util/debug').makeFileLogger(__filename);\nlet cache;\nlet expressSharp;\nlet missingDeps = '';\nconst markDepInvalid = (dep, e) => {\n    missingDeps += `- ${dep}: Reason: ${e.message.split('\\n')[0]}\\n`;\n};\ntry {\n    cache = require('apicache').middleware;\n} catch (e) {\n    markDepInvalid('apicache', e);\n}\ntry {\n    expressSharp = require('@magento/express-sharp');\n} catch (e) {\n    markDepInvalid('@magento/express-sharp', e);\n}\n\nfunction addImgOptMiddleware(app, env = process.env) {\n    const imgOptConfig = {\n        baseHost: env.MAGENTO_BACKEND_URL,\n        mountPoint: env.IMAGE_SERVICE_PATH,\n        cacheExpires: env.IMAGE_CACHE_EXPIRES,\n        debugCache: env.IMAGE_CACHE_DEBUG,\n        redis: env.IMAGE_CACHE_REDIS_CLIENT\n    };\n    debug(\n        `mounting onboard image optimization middleware express-sharp with config %o`,\n        imgOptConfig\n    );\n    let cacheMiddleware;\n    let sharpMiddleware;\n    try {\n        cacheMiddleware = cache(imgOptConfig.cacheExpires, null, {\n            debug: imgOptConfig.debugCache,\n            redisClient:\n                imgOptConfig.redis &&\n                require('redis').redisClient(imgOptConfig.redis)\n        });\n    } catch (e) {\n        markDepInvalid('apicache', e);\n    }\n    try {\n        sharpMiddleware = expressSharp({\n            baseHost: imgOptConfig.baseHost\n        });\n    } catch (e) {\n        markDepInvalid('@magento/express-sharp', e);\n    }\n    if (missingDeps) {\n        console.warn(\n            `Cannot add image optimization middleware due to dependencies that are not installed or are not compatible with this environment:\n${missingDeps}\nImages will be served uncompressed.\n\nIf possible, install additional tools to build NodeJS native dependencies:\nhttps://github.com/nodejs/node-gyp#installation`\n        );\n    } else {\n        app.use(imgOptConfig.mountPoint, cacheMiddleware, sharpMiddleware);\n    }\n}\n\nmodule.exports = addImgOptMiddleware;\n"],"file":"addImgOptMiddleware.js"}