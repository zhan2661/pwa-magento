{"version":3,"sources":["../../src/magento-layout-loader/babel-plugin-magento-layout.js"],"names":["validateConfig","require","addDefault","noop","module","exports","babelPluginMagentoLayout","types","t","validationRan","visitor","Program","exit","programPath","state","config","prod","onWarning","onError","opts","passed","error","reactModuleImports","identifiersInScopeFromModule","reactIdentifier","createElementIdentifier","reduce","acc","importData","bindingName","local","traverse","CallExpression","path","isCECall","isCreateElementCall","element","get","dataMIDPropNode","getProp","value","dataMID","type","isStringLiteral","operations","length","ContainerOperationsProcessor","containerPath","containerMID","program","execute","constructor","Object","assign","step","cachedContainerChildIdent","currentOperation","isDone","operation","getContainerChildIdentifier","containerChildIdent","find","findContainerChildByName","targetChildID","children","matchingChild","child","isElement","isCallExpression","elementIdentifier","node","arguments","name","idPropNode","buildCreateElementCall","props","callee","identifier","memberExpression","elementNode","react","isCompatTag","stringLiteral","callExpression","nullLiteral","insertAdjacentArgumentsNode","position","callPath","targetArg","exprNode","args","targetArgIndex","indexOf","targetIndex","splice","insertElementAdjacentToChild","targetChild","componentPath","targetChildPath","targetContainer","componentIdent","nameHint","extensionNode","removeContainer","remove","removeChild","insertBefore","insertAfter","callExprPath","propName","isObjectExpression","prop","properties","currentPropName","key","reactIdent","createElementIdent","isMemberExpression","matchesPattern","isIdentifier","equals","reModuleSpec","targetImportDecls","filter","isImportDeclaration","moduleSpec","source","test","importDecl","spec","specifiers","push","imported"],"mappings":"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","sourcesContent":["const validateConfig = require('./validateConfig');\nconst { addDefault } = require('@babel/helper-module-imports');\n\nconst noop = () => {};\nmodule.exports = babelPluginMagentoLayout;\n\nfunction babelPluginMagentoLayout({ types: t }) {\n    // Babel 6 only let's you read plugin options inside visitors,\n    // so we can't warn about an invalid config until the first file is hit.\n    // TODO: In Babel 7, use config passed in when plugin is first created. For now,\n    // this hacky flag is kept in a closure to prevent us from doing config validation\n    // on every file transformed\n    let validationRan;\n\n    return {\n        visitor: {\n            Program: {\n                // Our plugin could be (and frequently is) running along with other Babel\n                // plugins, including the JSX transform. Babel's visitor merging behavior\n                // will make this plugin susceptible to hard-to-debug plugin/preset ordering\n                // issues. To avoid this entirely, we don't start our work until the depth-first\n                // traversal of the AST completes. On Program:exit, we can safely start our work\n                exit(programPath, state) {\n                    // Babel 6 only let's you read plugin options inside visitors,\n                    // so we can't warn about an invalid config until the first file is hit.\n                    // TODO: In Babel 7, use config passed in when plugin is first created\n                    const {\n                        config,\n                        prod = false,\n                        onWarning = noop,\n                        onError = noop\n                    } = state.opts;\n\n                    if (!validationRan) {\n                        validationRan = true;\n                        if (typeof prod !== 'boolean') {\n                            onError(\n                                `Expected \"prod\" to be a boolean, but received \"${typeof prod}\"`\n                            );\n                        }\n                        if (typeof config !== 'object') {\n                            onError(\n                                `Expected \"config\" to be an object, but received \"${typeof config}\"`\n                            );\n                        }\n\n                        const { passed, error } = validateConfig(config);\n                        if (!passed) {\n                            // Warn about invalid config, but let the compilation\n                            // keep going\n                            onWarning(error);\n                        }\n                    }\n\n                    // We need to find any identifiers in scope that could be used to call\n                    // React's `createElement` function.\n                    const reactModuleImports = identifiersInScopeFromModule(\n                        programPath,\n                        /^react$/\n                    );\n                    const {\n                        reactIdentifier,\n                        createElementIdentifier\n                    } = reactModuleImports.reduce((acc, importData) => {\n                        if (importData.bindingName === 'default') {\n                            acc.reactIdentifier = importData.local;\n                        }\n                        if (importData.bindingName === 'createElement') {\n                            acc.createElementIdentifier = importData.local;\n                        }\n                        return acc;\n                    }, {});\n\n                    // No element creation in this file, so we bail\n                    if (!(reactIdentifier || createElementIdentifier)) {\n                        return;\n                    }\n\n                    // Start the transformation traversal\n                    programPath.traverse({\n                        CallExpression(path) {\n                            const isCECall = isCreateElementCall(\n                                path,\n                                reactIdentifier,\n                                createElementIdentifier\n                            );\n                            if (!isCECall) return;\n\n                            const [element] = path.get('arguments');\n                            const dataMIDPropNode = getProp(path, 'data-mid');\n                            if (!dataMIDPropNode) return;\n\n                            const { value: dataMID, type } = dataMIDPropNode;\n                            if (type !== 'StringLiteral') {\n                                onWarning(\n                                    'Expected \"data-mid\" to be a literal string, ' +\n                                        `but instead found a value of type \"${type}\"`\n                                );\n                            }\n\n                            if (!t.isStringLiteral(element)) {\n                                onWarning(\n                                    '\"data-mid\" found on a Composite Component.' +\n                                        'Only DOM elements(div/span/etc) can be a Layout Container'\n                                );\n                            }\n\n                            const operations = config[dataMID];\n                            // No operations were registered for this Container\n                            if (!(operations && operations.length)) {\n                                return;\n                            }\n\n                            new ContainerOperationsProcessor({\n                                types: t,\n                                operations,\n                                containerPath: path,\n                                containerMID: dataMID,\n                                program: programPath,\n                                reactIdentifier,\n                                createElementIdentifier,\n                                onWarning,\n                                onError\n                            }).execute();\n                        }\n                    });\n                }\n            }\n        }\n    };\n}\n\nclass ContainerOperationsProcessor {\n    constructor({\n        types,\n        operations,\n        containerPath,\n        containerMID,\n        program,\n        reactIdentifier,\n        createElementIdentifier,\n        onWarning,\n        onError\n    }) {\n        Object.assign(this, {\n            types,\n            operations,\n            containerPath,\n            containerMID,\n            program,\n            reactIdentifier,\n            createElementIdentifier,\n            onWarning,\n            onError\n        });\n        this.step = 0;\n        this.cachedContainerChildIdent = null;\n    }\n\n    get currentOperation() {\n        return this.operations[this.step];\n    }\n\n    get isDone() {\n        return this.step + 1 > this.operations.length;\n    }\n\n    execute() {\n        while (!this.isDone) {\n            this[this.currentOperation.operation]();\n            ++this.step;\n        }\n    }\n\n    /**\n     * Determine the local identifier for Peregrine's `ContainerChild` component.\n     * This method makes the assumption that the module specifier for a Peregrine\n     * import will always be `@magento/peregrine`. Can make this configurable in the\n     * future if necessary.\n     * @returns {string|null}\n     */\n    getContainerChildIdentifier() {\n        const { cachedContainerChildIdent } = this;\n        if (cachedContainerChildIdent) return cachedContainerChildIdent;\n\n        const { program } = this;\n        const containerChildIdent = identifiersInScopeFromModule(\n            program,\n            /^@magento\\/peregrine$/\n        ).find(({ bindingName }) => bindingName === 'ContainerChild');\n\n        if (containerChildIdent) {\n            this.cachedContainerChildIdent = containerChildIdent.local;\n        }\n\n        return this.cachedContainerChildIdent;\n    }\n\n    /**\n     * Given the identifier for a <ContainerChild />, will return a Babel path\n     * for the matching child in the currently-targeted Container\n     * @param {string} name\n     * @returns {Path|null}\n     */\n    findContainerChildByName(targetChildID) {\n        const {\n            containerPath,\n            reactIdentifier,\n            createElementIdentifier\n        } = this;\n        const containerChildIdent = this.getContainerChildIdentifier();\n\n        const [, , ...children] = this.containerPath.get('arguments');\n        const matchingChild = children.find(child => {\n            // TODO: warn when child is not a ContainerChild\n            const isElement =\n                child.isCallExpression() &&\n                isCreateElementCall(\n                    containerPath,\n                    reactIdentifier,\n                    createElementIdentifier\n                );\n            if (!isElement) return;\n\n            // Verify the child is a Peregrine ContainerChild\n            const [elementIdentifier] = child.node.arguments;\n            if (elementIdentifier.name !== containerChildIdent) return;\n\n            const idPropNode = getProp(child, 'id');\n            return idPropNode && idPropNode.value === targetChildID;\n        });\n        return matchingChild || null;\n    }\n\n    /**\n     * Given an element name, and optional props and children,\n     * returns a Node representing a call to React's createElement\n     * @param {string} element Identifier for Composite Component or DOM Element\n     * @param {object=} props\n     * @returns {Node}\n     */\n    buildCreateElementCall(element, props) {\n        const { types: t, reactIdentifier, createElementIdentifier } = this;\n        const callee = createElementIdentifier\n            ? t.identifier(createElementIdentifier)\n            : t.memberExpression(\n                  t.identifier(reactIdentifier),\n                  t.identifier('createElement')\n              );\n        const elementNode = !t.react.isCompatTag(element)\n            ? t.identifier(element) // Composite Component\n            : t.stringLiteral(element); // DOM Element\n        return t.callExpression(callee, [\n            elementNode,\n            props || t.nullLiteral()\n        ]);\n    }\n\n    /**\n     * Within a CallExpression, inserts a new expression AST node\n     * before or after the specified argument\n     * @param {'before'|'after'} position\n     * @param {Path} Babel path for a CallExpression\n     * @param {Node} targetArg AST Node in the arguments array to insert adjacent to\n     * @param {Node} exprNode An AST node representing any expression\n     */\n    insertAdjacentArgumentsNode(position, callPath, targetArg, exprNode) {\n        const { arguments: args } = callPath.node;\n        const targetArgIndex = args.indexOf(targetArg);\n        const targetIndex =\n            position === 'before' ? targetArgIndex : targetArgIndex + 1;\n        args.splice(targetIndex, 0, exprNode);\n    }\n\n    /**\n     * Used for insertBefore/insertAfter operations. Given a before\n     * or after position, locates the target ContainerChild in the\n     * current Container, and inserts an import declaration for an\n     * extension, along with the element in the proper position\n     * @param {'before'|'after'} position\n     */\n    insertElementAdjacentToChild(position) {\n        const { containerPath, currentOperation, onWarning } = this;\n        const { targetChild, componentPath } = currentOperation;\n        const targetChildPath = this.findContainerChildByName(targetChild);\n        if (!targetChildPath) {\n            onWarning(\n                `Attempted to inject a PWA Studio extension, but specified targetChild was not found\\n` +\n                    `operation: ${currentOperation.operation}\\n` +\n                    `targetContainer: ${currentOperation.targetContainer}\\n` +\n                    `targetChild: ${currentOperation.targetChild}`\n            );\n            return;\n        }\n        const componentIdent = addDefault(targetChildPath, componentPath, {\n            nameHint: 'Extension'\n        }).name;\n        // TODO: extensionNode needs to be wrapped in a new ContainerChild,\n        // and an error boundary\n        const extensionNode = this.buildCreateElementCall(componentIdent);\n        this.insertAdjacentArgumentsNode(\n            position,\n            containerPath,\n            targetChildPath.node,\n            extensionNode\n        );\n    }\n\n    removeContainer() {\n        const { isDone, containerPath, containerMID, onWarning } = this;\n        containerPath.remove();\n        if (!isDone) {\n            // TODO: Consider listing the operations that were skipped,\n            // so a developer knows what extensions likely will not work.\n            // An extension operating on a removed container indicates a conflict\n            // between 2 modules\n            onWarning(\n                `A remove operation was executed on Container ` +\n                    `${containerMID}, but other operations were still ` +\n                    'pending on it. This most commonly indicates' +\n                    'a conflict or ordering issue between modules/extensions'\n            );\n        }\n        // Short-circuit operations, since there is no more work to do\n        // on a removed Container\n        this.step = this.operations.length;\n    }\n\n    /**\n     * Remove a ContainerChild inside of a Container\n     */\n    removeChild() {\n        const { currentOperation, onWarning } = this;\n        const { targetChild } = currentOperation;\n        const targetChildPath = this.findContainerChildByName(targetChild);\n        if (!targetChildPath) {\n            onWarning(\n                `Attempted to remove a PWA Studio ContainerChild, but could not locate it\\n` +\n                    'operation: removeChild\\n' +\n                    `targetContainer: ${currentOperation.targetContainer}\\n` +\n                    `targetChild: ${currentOperation.targetChild}\\n`\n            );\n            return;\n        }\n        targetChildPath.remove();\n    }\n\n    /**\n     * Insert an element before the specified ContainerChild\n     */\n    insertBefore() {\n        this.insertElementAdjacentToChild('before');\n    }\n\n    /**\n     * Insert an element after the specified ContainerChild\n     */\n    insertAfter() {\n        this.insertElementAdjacentToChild('after');\n    }\n}\n\n/**\n * Given a Babel path wrapping a call to createElement,\n * will return the value of the specified prop, if present.\n * @param {Path} propsPath\n * @param {string} prop\n * @returns {Node}\n */\nfunction getProp(callExprPath, propName) {\n    const [, props] = callExprPath.get('arguments');\n    // Could be a NullLiteral if the element has no props\n    if (!props.isObjectExpression()) return;\n\n    for (const prop of props.node.properties) {\n        // Key can either be an identifier (.name) or a string literal (.value)\n        const currentPropName = prop.key.value || prop.key.name;\n        if (currentPropName === propName) return prop.value;\n    }\n}\n\n/**\n * Given a Babel path wrapping a CallExpression,\n * returns a boolean indicating whether the path\n * is a call to React's createElement function\n * @param {Path} callExprPath\n * @param {string=} reactIdent String representing the identifier in scope for React\n * @param {string=} createElementIdent String representing the identifier in scope for createElement\n * @returns {bool}\n */\nfunction isCreateElementCall(callExprPath, reactIdent, createElementIdent) {\n    const callee = callExprPath.get('callee');\n    // React.createElement()\n    if (callee.isMemberExpression()) {\n        return callee.matchesPattern(`${reactIdent}.createElement`);\n    }\n\n    // createElement()\n    if (callee.isIdentifier()) {\n        return callee.equals('name', createElementIdent);\n    }\n\n    return false;\n}\n\n/**\n * Given a Babel path wrapping the `Program` node, and\n * a regex for matching against module specifiers, returns\n * named (and default) imports pulled into scope from that\n * module, and their optionally aliased values\n * @param {Path} programPath\n * @param {RegExp} reModuleSpec\n * @returns {Array<{bindingName: string, local: string}>}\n */\nfunction identifiersInScopeFromModule(programPath, reModuleSpec) {\n    const targetImportDecls = programPath.get('body').filter(path => {\n        if (!path.isImportDeclaration()) return;\n        const moduleSpec = path.node.source.value;\n        return reModuleSpec.test(moduleSpec);\n    });\n\n    return targetImportDecls.reduce((acc, importDecl) => {\n        for (const spec of importDecl.node.specifiers) {\n            acc.push({\n                bindingName:\n                    spec.type === 'ImportDefaultSpecifier'\n                        ? 'default'\n                        : spec.imported.name,\n                local: spec.local.name\n            });\n        }\n\n        return acc;\n    }, []);\n}\n"],"file":"babel-plugin-magento-layout.js"}